// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Vertical {
  BARBER
  SPA
  NAILS
  HAIR
  AESTHETIC
}

enum Role {
  ADMIN
  STAFF
  CLIENT
}

enum Level {
  JUNIOR
  SENIOR
  MASTER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CHECK_IN
  COMPLETED
  CANCELLED
}

enum LoyaltyTier {
  BRONZE
  SILVER
  GOLD
}

// ============================================================================
// CORE MODELS
// ============================================================================

model Tenant {
  id                String      @id @default(cuid())
  name              String
  slug              String      @unique // subdominio.app.com
  vertical          Vertical
  email             String      @unique
  phone             String?
  logo              String?
  configRewards     Json? // Reglas de puntos y tiers
  depositPercentage Float       @default(25) // Porcentaje de depósito requerido
  bufferTime        Int         @default(15) // Minutos de limpieza entre citas
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  users             User[]
  clients           Client[]
  services          Service[]
  appointments      Appointment[]
  payments          Payment[]
  loyaltyRules      LoyaltyRule[]
  businessHours     BusinessHours[]

  @@index([slug])
  @@index([vertical])
}

model User {
  id                String      @id @default(cuid())
  tenantId          String
  email             String
  pin               String // Hashed PIN (4 digits)
  role              Role
  level             Level       @default(JUNIOR)
  firstName         String
  lastName          String
  phone             String?
  skills            String[] // Especialidades (JSON array)
  lunchTimeStart    String? // Ej: "14:00"
  lunchTimeEnd      String? // Ej: "15:00"
  commissionRate    Float       @default(20) // Porcentaje de comisión
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments      Appointment[]
  notes             ServiceNote[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([role])
}

model Client {
  id                String      @id @default(cuid())
  tenantId          String
  qrCode            String      @unique
  email             String?
  phone             String?
  firstName         String
  lastName          String
  medicalNotes      String? // Notas médicas
  allergies         String[] // Alergias (JSON array)
  loyaltyPoints     Int         @default(0)
  loyaltyTier       LoyaltyTier @default(BRONZE)
  profileImage      String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments      Appointment[]
  payments          Payment[]
  beforeAfterPhotos BeforeAfterPhoto[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([qrCode])
}

model Service {
  id                String      @id @default(cuid())
  tenantId          String
  name              String
  description       String?
  durationMinutes   Int
  basePrice         Float
  juniorPrice       Float? // Precio específico para Junior
  seniorPrice       Float? // Precio específico para Senior
  masterPrice       Float? // Precio específico para Master
  category          String? // Categoría de servicio
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  appointments      Appointment[]

  @@index([tenantId])
  @@index([category])
}

model Appointment {
  id                String      @id @default(cuid())
  tenantId          String
  clientId          String
  staffId           String
  serviceId         String
  startTime         DateTime
  endTime           DateTime
  status            AppointmentStatus @default(PENDING)
  depositPaid       Boolean     @default(false)
  depositAmount     Float?
  totalPrice        Float
  notes             String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client            Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  staff             User        @relation(fields: [staffId], references: [id], onDelete: Restrict)
  service           Service     @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  payment           Payment?
  serviceNotes      ServiceNote[]

  @@index([tenantId])
  @@index([clientId])
  @@index([staffId])
  @@index([status])
  @@index([startTime])
}

model Payment {
  id                String      @id @default(cuid())
  tenantId          String
  clientId          String
  appointmentId     String?
  amount            Float
  type              String // DEPOSIT, FULL_PAYMENT, PENALTY_REFUND
  stripePaymentId   String?
  status            String      @default("pending") // pending, completed, failed
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client            Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  appointment       Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([clientId])
  @@index([status])
}

model ServiceNote {
  id                String      @id @default(cuid())
  appointmentId     String
  staffId           String
  content           String
  photoUrl          String?
  createdAt         DateTime    @default(now())

  // Relations
  appointment       Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  staff             User        @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
  @@index([staffId])
}

model BeforeAfterPhoto {
  id                String      @id @default(cuid())
  clientId          String
  beforeUrl         String
  afterUrl          String
  serviceType       String
  createdAt         DateTime    @default(now())

  // Relations
  client            Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model LoyaltyRule {
  id                String      @id @default(cuid())
  tenantId          String
  tier              LoyaltyTier
  minPoints         Int
  maxPoints         Int?
  discount          Float? // Porcentaje de descuento
  benefits          String[] // Beneficios adicionales
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, tier])
  @@index([tenantId])
}

model BusinessHours {
  id                String      @id @default(cuid())
  tenantId          String
  dayOfWeek         Int // 0 = Sunday, 6 = Saturday
  openTime          String // "09:00"
  closeTime         String // "18:00"
  isClosed          Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, dayOfWeek])
  @@index([tenantId])
}
